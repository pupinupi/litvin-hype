<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ð›Ð¸Ñ‚Ð²Ð¸Ð½. ÐŸÑƒÑ‚ÑŒ Ðº Ñ…Ð°Ð¹Ð¿Ñƒ</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="start">
  <h2>Ð›Ð¸Ñ‚Ð²Ð¸Ð½. ÐŸÑƒÑ‚ÑŒ Ðº Ñ…Ð°Ð¹Ð¿Ñƒ</h2>
  <input id="name" placeholder="Ð˜Ð¼Ñ"><br>
  <input id="room" placeholder="ÐšÐ¾Ð´ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹"><br>

  <div>
    <div class="choice" data-color="red" style="background:red"></div>
    <div class="choice" data-color="blue" style="background:blue"></div>
    <div class="choice" data-color="green" style="background:green"></div>
    <div class="choice" data-color="yellow" style="background:yellow"></div>
  </div>

  <button onclick="enter()">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
</div>

<div id="game" style="display:none">
  <div id="board">
    <img src="board.jpg" class="board-img">
  </div>
  <div id="dice">ðŸŽ²</div>
  <div id="info"></div>
</div>

<div id="popup"></div>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io();
let room="";
let color=null;
let positions=[];

const board=document.getElementById("board");

function buildPositions(){
  const size=board.offsetWidth;
  const m=size*0.08;
  const s=(size-m*2)/4;
  positions=[];
  for(let i=0;i<5;i++)
    positions.push({x:m,y:size-m-i*s});
  for(let i=1;i<5;i++)
    positions.push({x:m+i*s,y:m});
  for(let i=4;i>=0;i--)
    positions.push({x:size-m,y:m+(4-i)*s});
  for(let i=4;i>0;i--)
    positions.push({x:m+(i-1)*s,y:size-m});
}

window.onload=buildPositions;
window.onresize=buildPositions;

document.querySelectorAll(".choice").forEach(el=>{
  el.onclick=()=>{
    document.querySelectorAll(".choice")
      .forEach(c=>c.style.outline="none");
    el.style.outline="3px solid white";
    color=el.dataset.color;
  };
});

function enter(){
  const name=document.getElementById("name").value;
  room=document.getElementById("room").value;
  if(!name||!room||!color) return alert("Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÑ‘");
  socket.emit("joinRoom",{name,room,color});
  document.getElementById("start").style.display="none";
  document.getElementById("game").style.display="block";
}

document.getElementById("dice").onclick=()=>{
  socket.emit("rollDice",room);
};

socket.on("dice",d=>{
  document.getElementById("dice").innerText=d;
});

socket.on("update",data=>{
  document.querySelectorAll(".token").forEach(t=>t.remove());
  data.players.forEach((p,i)=>{
    if(!positions[p.position]) return;
    const t=document.createElement("div");
    t.className="token";
    t.style.background=p.color;
    t.style.left=positions[p.position].x+"px";
    t.style.top=positions[p.position].y+"px";
    board.appendChild(t);
  });
  document.getElementById("info").innerHTML=
    data.players.map(p=>p.name+": "+p.hype+" Ñ…Ð°Ð¹Ð¿Ð°").join("<br>");
});

socket.on("scandal",txt=>{
  const p=document.getElementById("popup");
  p.innerText="Ð¡ÐšÐÐÐ”ÐÐ›: "+txt;
  p.style.display="block";
  setTimeout(()=>p.style.display="none",2000);
});
</script>

</body>
</html>
