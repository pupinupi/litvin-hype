<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Litvin Hype ULTIMATE</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="start">
<h2>Litvin Hype</h2>
<input id="name" placeholder="–ò–º—è">
<input id="room" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">

<div id="colors">
<div class="choice" data-color="red" style="background:red;"></div>
<div class="choice" data-color="blue" style="background:blue;"></div>
<div class="choice" data-color="green" style="background:green;"></div>
<div class="choice" data-color="yellow" style="background:yellow;"></div>
</div>

<button id="join">–ò–≥—Ä–∞—Ç—å</button>
</div>

<div id="game" style="display:none;">
<div id="board">
<img src="board.jpg" id="boardImg">
<div id="tokens"></div>
<div id="highlight"></div>
</div>

<div id="diceSection">
<div id="dice3d">
<div class="cube" id="cube">
<div class="face front">1</div>
<div class="face back">6</div>
<div class="face right">3</div>
<div class="face left">4</div>
<div class="face top">2</div>
<div class="face bottom">5</div>
</div>
</div>
<button id="rollBtn">–ë—Ä–æ—Å–∏—Ç—å</button>
</div>

<div id="info"></div>
</div>

<div id="modal"></div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket=io();
let myRoom=null;
let selectedColor=null;
let state=null;
let animating=false;

const positions=[
{ x:113,y:588},{ x:108,y:464},{ x:108,y:345},{ x:108,y:235},{ x:108,y:135},
{ x:232,y:83},{ x:359,y:88},{ x:511,y:91},{ x:660,y:88},{ x:798,y:88},
{ x:920,y:119},{ x:903,y:243},{ x:901,y:351},{ x:895,y:461},{ x:895,y:580},
{ x:776,y:610},{ x:644,y:602},{ x:514,y:602},{ x:365,y:599},{ x:224,y:605}
];

// –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
document.querySelectorAll(".choice").forEach(c=>{
  c.onclick=()=>{
    document.querySelectorAll(".choice").forEach(x=>x.classList.remove("sel"));
    c.classList.add("sel");
    selectedColor=c.getAttribute("data-color");
  };
});

join.onclick=()=>{
  const nameVal=name.value.trim();
  const roomVal=room.value.trim();
  if(!nameVal||!roomVal||!selectedColor){
    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë");
    return;
  }

  myRoom=roomVal;

  socket.emit("joinRoom",{
    name:nameVal,
    room:roomVal,
    color:selectedColor
  });

  start.style.display="none";
  game.style.display="block";
};

socket.on("state",s=>{
  state=s;
  render();
});

function render(){

  const layer=document.getElementById("tokens");
  layer.innerHTML="";

  state.players.forEach(p=>{
    const token=document.createElement("div");
    token.className="token";
    token.style.background=p.color;
    token.style.transform=`translate(${positions[p.position].x}px,${positions[p.position].y}px)`;
    layer.appendChild(token);
  });

  let html="<h3>–ò–≥—Ä–æ–∫–∏:</h3>";
  state.players.forEach(p=>{
    html+=`<div><span style="color:${p.color}">${p.name}</span> ‚Äî ${p.hype} —Ö–∞–π–ø</div>`;
  });

  const current=state.players[state.turn];
  html+=`<hr>–•–æ–¥–∏—Ç: ${current.name}`;

  info.innerHTML=html;

  rollBtn.disabled=(current.id!==socket.id)||animating;
}

// üé≤ 3D –∫—É–±–∏–∫
function rotateCube(num){
  const cube=document.getElementById("cube");
  const map={
    1:"rotateX(0deg) rotateY(0deg)",
    2:"rotateX(-90deg)",
    3:"rotateY(-90deg)",
    4:"rotateY(90deg)",
    5:"rotateX(90deg)",
    6:"rotateX(180deg)"
  };
  cube.style.transform=map[num];
}

rollBtn.onclick=()=>{
  socket.emit("rollDice",myRoom);
};

socket.on("roll",num=>{
  animating=true;
  rotateCube(num);
});

// –ø–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
socket.on("state",s=>{
  if(!state){ state=s; render(); return; }

  const old=state;
  state=s;

  const moving=state.players.find((p,i)=>
    p.position!==old.players[i]?.position
  );

  if(moving){
    animateMove(old.players.find(p=>p.id===moving.id)?.position||0,moving.position,moving.id);
  } else {
    render();
  }
});

function animateMove(from,to,id){
  animating=true;

  let step=from;

  function next(){
    if(step===to){
      animating=false;
      highlightCell(to);
      render();
      return;
    }
    step=(step+1)%20;
    state.players.find(p=>p.id===id).position=step;
    render();
    setTimeout(next,200);
  }
  next();
}

function highlightCell(pos){
  const h=document.getElementById("highlight");
  h.style.left=positions[pos].x+"px";
  h.style.top=positions[pos].y+"px";
  h.style.opacity=1;
  setTimeout(()=>h.style.opacity=0,800);
}

// —Å–∫–∞–Ω–¥–∞–ª
socket.on("scandal",text=>{
  modal.innerHTML=`
    <div class="modalBox">
      <h2>–°–ö–ê–ù–î–ê–õ</h2>
      <p>${text}</p>
      <button onclick="modal.style.display='none'">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
  `;
  modal.style.display="flex";
});

// –ø–æ–±–µ–¥–∞
socket.on("winner",name=>{
  modal.innerHTML=`
    <div class="modalBox">
      <h1>${name} –ø–æ–±–µ–¥–∏–ª! üèÜ</h1>
      <button onclick="location.reload()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
  `;
  modal.style.display="flex";
});

</script>
</body>
</html>
