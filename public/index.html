<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Litvin Hype Ultimate</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="startScreen">
<h2>Litvin Hype</h2>

<input id="nameInput" placeholder="Имя">
<input id="roomInput" placeholder="Код комнаты">

<div id="colors">
<div class="choice" data-color="red" style="background:red;"></div>
<div class="choice" data-color="blue" style="background:blue;"></div>
<div class="choice" data-color="green" style="background:green;"></div>
<div class="choice" data-color="yellow" style="background:yellow;"></div>
</div>

<button id="joinBtn">Играть</button>
</div>

<div id="gameScreen" style="display:none;">

<div id="board">
<img src="board.jpg" id="boardImg">
<div id="tokens"></div>
</div>

<div id="diceSection">
<div id="dice">⚀</div>
<button id="rollBtn">Бросить</button>
</div>

<div id="info"></div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();

let state = null;
let previousState = null;
let selectedColor = null;
let myRoom = null;
let animating = false;

const startScreen = document.getElementById("startScreen");
const gameScreen = document.getElementById("gameScreen");
const joinBtn = document.getElementById("joinBtn");
const rollBtn = document.getElementById("rollBtn");
const nameInput = document.getElementById("nameInput");
const roomInput = document.getElementById("roomInput");
const infoBox = document.getElementById("info");

const positions = [
{ x:113,y:588},{ x:108,y:464},{ x:108,y:345},{ x:108,y:235},{ x:108,y:135},
{ x:232,y:83},{ x:359,y:88},{ x:511,y:91},{ x:660,y:88},{ x:798,y:88},
{ x:920,y:119},{ x:903,y:243},{ x:901,y:351},{ x:895,y:461},{ x:895,y:580},
{ x:776,y:610},{ x:644,y:602},{ x:514,y:602},{ x:365,y:599},{ x:224,y:605}
];

// выбор цвета
document.querySelectorAll(".choice").forEach(c=>{
  c.onclick = ()=>{
    document.querySelectorAll(".choice").forEach(x=>x.classList.remove("sel"));
    c.classList.add("sel");
    selectedColor = c.dataset.color;
  };
});

// вход
joinBtn.onclick = ()=>{
  const name = nameInput.value.trim();
  const room = roomInput.value.trim();

  if(!name || !room || !selectedColor){
    alert("Заполните всё");
    return;
  }

  myRoom = room;

  socket.emit("joinRoom",{
    name: name,
    room: room,
    color: selectedColor
  });

  startScreen.style.display = "none";
  gameScreen.style.display = "block";
};

// кубик
socket.on("state", newState => {

  if(!state){
    state = newState;
    render();
    return;
  }

  const currentPlayer = state.players[state.turn];
  const updatedPlayer = newState.players.find(p => p.id === currentPlayer.id);

  const oldPosition = currentPlayer.position;
  const newPosition = updatedPlayer.position;

  state = newState;

  if(oldPosition !== newPosition){
    animateMove(oldPosition, newPosition, updatedPlayer.id);
  } else {
    render();
  }

});

// обновление состояния
socket.on("state", newState => {

  if(!previousState){
    previousState = JSON.parse(JSON.stringify(newState));
    state = newState;
    render();
    return;
  }

  const moved = newState.players.find((p,i)=>
    p.position !== previousState.players[i].position
  );

  state = newState;

  if(moved){
    animateMove(
      previousState.players.find(p=>p.id===moved.id).position,
      moved.position,
      moved.id
    );
  } else {
    render();
  }

  previousState = JSON.parse(JSON.stringify(newState));
});

function animateMove(from, to, playerId){

  animating = true;

  let current = from;

  function step(){

    if(current === to){
      animating = false;
      render();
      return;
    }

    current = (current + 1) % 20;

    const player = state.players.find(p=>p.id===playerId);
    player.position = current;

    render();

    setTimeout(step, 250);
  }

  step();
}

    current = (current + 1) % 20;
    state.players.find(p=>p.id===playerId).position = current;
    render();

    setTimeout(step, 250);
  }

  step();
}

function render(){

  const layer = document.getElementById("tokens");
  layer.innerHTML = "";

  state.players.forEach(p=>{

    const token = document.createElement("div");
    token.className = "token";

    if(p.id === state.players[state.turn].id){
      token.classList.add("active");
    }

    token.style.background = p.color;
    token.style.transform =
      `translate(${positions[p.position].x}px,${positions[p.position].y}px)`;

    layer.appendChild(token);
  });

  let html = "<h3>Игроки:</h3>";
  state.players.forEach(p=>{
    html += `<div><span style="color:${p.color}">${p.name}</span> — ${p.hype} хайп</div>`;
  });

  infoBox.innerHTML = html;

  rollBtn.disabled =
    animating ||
    state.players[state.turn].id !== socket.id;
}

rollBtn.onclick = ()=>{
  socket.emit("rollDice", myRoom);
};

</script>
</body>
</html>
