<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Litvin Hype</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="startScreen">
<h2>Litvin Hype</h2>

<input id="nameInput" placeholder="Имя">
<input id="roomInput" placeholder="Код комнаты">

<div id="colors">
<div class="choice" data-color="red" style="background:red;"></div>
<div class="choice" data-color="blue" style="background:blue;"></div>
<div class="choice" data-color="green" style="background:green;"></div>
<div class="choice" data-color="yellow" style="background:yellow;"></div>
</div>

<button id="joinBtn">Играть</button>
</div>

<div id="gameScreen" style="display:none;">

<div id="boardWrapper">
<div id="board"></div>
</div>

<div id="diceSection">
<img id="diceImg" src="dice1.png">
<button id="rollBtn">Бросить кубик</button>
</div>

<div id="playersInfo"></div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();

let selectedColor = null;
let myRoom = null;
let state = null;
let myId = null;
let animating = false;

const CELL_COORDS = [
{left:80, top:900},  // 1 старт
{left:80, top:760},
{left:80, top:620},
{left:80, top:480},
{left:80, top:340},
{left:200, top:200},
{left:350, top:200},
{left:500, top:200},
{left:650, top:200},
{left:800, top:340},
{left:800, top:480},
{left:800, top:620},
{left:800, top:760},
{left:800, top:900},
{left:650, top:950},
{left:500, top:950},
{left:350, top:950},
{left:200, top:950},
{left:120, top:900},
{left:200, top:900}
];

const nameInput = document.getElementById("nameInput");
const roomInput = document.getElementById("roomInput");
const joinBtn = document.getElementById("joinBtn");
const startScreen = document.getElementById("startScreen");
const gameScreen = document.getElementById("gameScreen");
const rollBtn = document.getElementById("rollBtn");
const playersInfo = document.getElementById("playersInfo");
const diceImg = document.getElementById("diceImg");
const board = document.getElementById("board");

// выбор цвета
document.querySelectorAll(".choice").forEach(c=>{
  c.onclick = function(){
    document.querySelectorAll(".choice").forEach(x=>x.classList.remove("sel"));
    this.classList.add("sel");
    selectedColor = this.getAttribute("data-color");
  };
});

// вход
joinBtn.onclick = function(){

  const name = nameInput.value.trim();
  const room = roomInput.value.trim();

  if(!name || !room || !selectedColor){
    alert("Заполните всё");
    return;
  }

  myRoom = room;

  socket.emit("joinRoom", {
    name,
    room,
    color: selectedColor
  });

  startScreen.style.display = "none";
  gameScreen.style.display = "block";
};

// состояние
socket.on("state", function(newState){

  if(!state){
    state = newState;
    myId = socket.id;
    render();
    return;
  }

  const oldMe = state.players.find(p=>p.id===myId);
  const newMe = newState.players.find(p=>p.id===myId);

  state = newState;

  if(oldMe && newMe && oldMe.position !== newMe.position){
    animateMove(oldMe.position, newMe.position);
  } else {
    render();
  }

});

// анимация движения
function animateMove(from, to){

  animating = true;
  let current = from;

  function step(){

    if(current === to){
      animating = false;
      render();
      return;
    }

    current = (current + 1) % 20;

    const me = state.players.find(p=>p.id===myId);
    me.position = current;

    render();
    setTimeout(step, 250);
  }

  step();
}

// отрисовка
function render(){

  board.innerHTML = "";

  state.players.forEach(p=>{

    const coord = CELL_COORDS[p.position];

    const token = document.createElement("div");
    token.className = "token";
    token.style.background = p.color;
    token.style.left = coord.left + "px";
    token.style.top = coord.top + "px";

    if(p.id === state.players[state.turn].id){
      token.classList.add("active");
    }

    board.appendChild(token);
  });

  let html = "";
  state.players.forEach(p=>{
    html += "<div style='color:"+p.color+"'>" +
            p.name + " — " + p.hype + " хайп</div>";
  });

  playersInfo.innerHTML = html;
}

// бросок кубика
rollBtn.onclick = function(){
  if(animating) return;
  socket.emit("rollDice", myRoom);
};

// показать кубик
socket.on("diceRolled", function(num){
  diceImg.src = "dice" + num + ".png";
});

</script>
</body>
</html>
