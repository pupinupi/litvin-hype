<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Litvin Hype Ultimate</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="start">
<h2>Litvin Hype</h2>
<input id="nameInput" placeholder="Имя">
<input id="roomInput" placeholder="Код комнаты">

<div id="colors">
<div class="choice" data-color="red" style="background:red;"></div>
<div class="choice" data-color="blue" style="background:blue;"></div>
<div class="choice" data-color="green" style="background:green;"></div>
<div class="choice" data-color="yellow" style="background:yellow;"></div>
</div>

<button id="joinBtn">Играть</button>
</div>

<div id="game" style="display:none;">
<div id="board">
<img src="board.jpg" id="boardImg">
<div id="tokens"></div>
</div>

<div id="diceSection">
<div id="dice">⚀</div>
<button id="rollBtn">Бросить</button>
</div>

<div id="info"></div>
</div>

<div id="modal"></div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();

let state = null;
let previousState = null;
let myRoom = null;
let selectedColor = null;
let animating = false;

const positions = [
{ x:113,y:588},{ x:108,y:464},{ x:108,y:345},{ x:108,y:235},{ x:108,y:135},
{ x:232,y:83},{ x:359,y:88},{ x:511,y:91},{ x:660,y:88},{ x:798,y:88},
{ x:920,y:119},{ x:903,y:243},{ x:901,y:351},{ x:895,y:461},{ x:895,y:580},
{ x:776,y:610},{ x:644,y:602},{ x:514,y:602},{ x:365,y:599},{ x:224,y:605}
];

document.querySelectorAll(".choice").forEach(c=>{
  c.onclick=()=>{
    document.querySelectorAll(".choice").forEach(x=>x.classList.remove("sel"));
    c.classList.add("sel");
    selectedColor=c.dataset.color;
  };
});

joinBtn.onclick=()=>{
  const name=nameInput.value.trim();
  const room=roomInput.value.trim();
  if(!name||!room||!selectedColor){alert("Заполните всё");return;}
  myRoom=room;
  socket.emit("joinRoom",{name,room,color:selectedColor});
  start.style.display="none";
  game.style.display="block";
};

socket.on("roll",num=>{
  const diceFaces=["⚀","⚁","⚂","⚃","⚄","⚅"];
  document.getElementById("dice").innerText=diceFaces[num-1];
});

socket.on("state",newState=>{

  if(!previousState){
    previousState=JSON.parse(JSON.stringify(newState));
    state=newState;
    render();
    return;
  }

  const moving=newState.players.find((p,i)=>
    p.position!==previousState.players[i].position
  );

  state=newState;

  if(moving){
    animateMove(
      previousState.players.find(p=>p.id===moving.id).position,
      moving.position,
      moving.id
    );
  } else render();

  previousState=JSON.parse(JSON.stringify(newState));
});

function animateMove(from,to,id){

  animating=true;
  let current=from;

  function step(){
    if(current===to){
      animating=false;
      render();
      return;
    }

    current=(current+1)%20;
    state.players.find(p=>p.id===id).position=current;
    render();
    setTimeout(step,250);
  }

  step();
}

function render(){

  const layer=document.getElementById("tokens");
  layer.innerHTML="";

  state.players.forEach(p=>{
    const token=document.createElement("div");
    token.className="token";
    if(p.id===state.players[state.turn].id)
      token.classList.add("active");

    token.style.background=p.color;
    token.style.transform=`translate(${positions[p.position].x}px,${positions[p.position].y}px)`;
    layer.appendChild(token);
  });

  let html="<h3>Игроки:</h3>";
  state.players.forEach(p=>{
    html+=`<div><span style="color:${p.color}">${p.name}</span> — ${p.hype} хайп</div>`;
  });

  info.innerHTML=html;

  rollBtn.disabled=animating||state.players[state.turn].id!==socket.id;
}

</script>
</body>
</html>
